<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CASA DOMÓTICA — TUVN</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --muted:#6b7280; }
    body{font-family:Inter,Roboto,Arial;background:var(--bg);margin:0;padding:20px;color:#111}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    .status{font-size:14px;color:var(--muted)}
    .dev{font-size:13px;color:#374151;margin-top:4px}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;background:#111827;color:#fff}
    button.secondary{background:#6b7280}
    button.disabled{opacity:0.4;pointer-events:none}
    .panel-control{background:var(--card);padding:14px;margin-top:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .ctrl-row{display:flex;gap:10px;margin-top:10px}
    .modeIndicator{font-size:14px;margin-left:10px;font-weight:bold;}
    .green{color:#10b981}
    .red{color:#ef4444}

    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);text-align:center}
    .loc{font-weight:700}
    .temp{font-size:36px;margin-top:6px}
    .badge{padding:6px 10px;border-radius:20px;margin-top:8px;font-weight:600;color:white}
    .low{background:#3b82f6}
    .medium{background:#10b981}
    .normal{background:#111827}
    .high{background:#ef4444}

    main{max-width:1100px;margin:auto}
    .big{display:grid;grid-template-columns:1fr;gap:12px;margin-top:18px}
    @media(min-width:900px){.big{grid-template-columns:320px 1fr}}
    .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  </style>
</head>

<body>
  <main>
    <header>
      <div>
        <h1>CASA DOMÓTICA — TUVN</h1>
        <div class="dev">Desarrollado por: José Romero · Abraham Parreño</div>
        <div class="status" id="statusText">Estado: DESCONECTADO</div>
      </div>

      <div class="controls">
        <button id="connectBtn" onclick="toggleConnection()">Conectar BLE</button>
        <button class="secondary" id="simBtn" onclick="toggleSimulation()">Simular</button>
      </div>
    </header>

    <!-- PANEL DE CONTROL -->
    <section class="panel-control">
      <h3>Control de Ventilador y Calefactor</h3>
      <button id="modeBtn" onclick="toggleMode()">Modo Automático</button>
      <span id="modeIndicator" class="modeIndicator green">AUTO</span>

      <div class="ctrl-row">
        <button id="ventBtn" onclick="toggleVent()">Ventilador: OFF</button>
        <button id="calBtn" onclick="toggleCal()">Calefactor: OFF</button>
      </div>
    </section>

    <section class="grid">
      <div class="card"><div class="loc">SALA</div><div class="temp" id="val-sala">-- °C</div><div id="badge-sala" class="badge normal">--</div></div>
      <div class="card"><div class="loc">COCINA</div><div class="temp" id="val-cocina">-- °C</div><div id="badge-cocina" class="badge normal">--</div></div>
      <div class="card"><div class="loc">PATIO</div><div class="temp" id="val-patio">-- °C</div><div id="badge-patio" class="badge normal">--</div></div>
      <div class="card"><div class="loc">GARAJE</div><div class="temp" id="val-garaje">-- °C</div><div id="badge-garaje" class="badge normal">--</div></div>
    </section>

    <section class="big">
      <div class="panel">
        <div class="loc">PROMEDIO</div>
        <div class="temp" id="val-prom">-- °C</div>
        <div id="badge-prom" class="badge normal">--</div>
      </div>

      <div class="panel">
        <canvas id="chartMain"></canvas>
      </div>
    </section>
  </main>

<script>
/* ============================
   CONFIG
============================ */
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const MAX_SAMPLES = 20;

const AUTO_ON  = true;
const AUTO_OFF = false;

let modoAutomatico = true;
let ventiladorON = false;
let calefactorON = false;

let bleDevice=null;
let bleChar=null;
let connected=false;

/* ============================
   ENVÍO DE COMANDOS BLE
============================ */
async function sendCmd(cmd){
  if(!connected || !bleChar) return;
  try{
    await bleChar.writeValue(new TextEncoder().encode(cmd));
  }catch(e){ console.warn("BLE envío falló:", e); }
}

/* ============================
   BOTONES: MODO AUTOMÁTICO
============================ */
function toggleMode(){
  modoAutomatico = !modoAutomatico;

  document.getElementById("modeIndicator").textContent = modoAutomatico ? "AUTO" : "MANUAL";
  document.getElementById("modeIndicator").className   = modoAutomatico ? "modeIndicator green" : "modeIndicator red";
  document.getElementById("modeBtn").textContent       = modoAutomatico ? "Modo Automático" : "Modo Manual";

  // deshabilitar botones en automático
  document.getElementById("ventBtn").classList.toggle("disabled", modoAutomatico);
  document.getElementById("calBtn").classList.toggle("disabled", modoAutomatico);

  sendCmd(modoAutomatico ? "CMD:MODO_AUTO" : "CMD:MODO_MANUAL");
}

/* ============================
   VENTILADOR Y CALEFACTOR MANUAL
============================ */
function toggleVent(){
  ventiladorON = !ventiladorON;
  document.getElementById("ventBtn").textContent = "Ventilador: " + (ventiladorON ? "ON" : "OFF");
  sendCmd(ventiladorON ? "CMD:VENT_ON" : "CMD:VENT_OFF");
}

function toggleCal(){
  calefactorON = !calefactorON;
  document.getElementById("calBtn").textContent = "Calefactor: " + (calefactorON ? "ON" : "OFF");
  sendCmd(calefactorON ? "CMD:CAL_ON" : "CMD:CAL_OFF");
}

/* ============================
   LÓGICA AUTOMÁTICA
============================ */
function logicAuto(promedio){
  if(!modoAutomatico) return;

  if(promedio > 25){
    ventiladorON = true;
    calefactorON = false;
    sendCmd("CMD:VENT_ON");
    sendCmd("CMD:CAL_OFF");
    document.getElementById("ventBtn").textContent="Ventilador: ON";
    document.getElementById("calBtn").textContent="Calefactor: OFF";
  }
  else if(promedio < 20){
    ventiladorON = false;
    calefactorON = true;
    sendCmd("CMD:VENT_OFF");
    sendCmd("CMD:CAL_ON");
    document.getElementById("ventBtn").textContent="Ventilador: OFF";
    document.getElementById("calBtn").textContent="Calefactor: ON";
  }
  else{
    ventiladorON = false;
    calefactorON = false;
    sendCmd("CMD:VENT_OFF");
    sendCmd("CMD:CAL_OFF");
    document.getElementById("ventBtn").textContent="Ventilador: OFF";
    document.getElementById("calBtn").textContent="Calefactor: OFF";
  }
}

/* ============================
   (RESTO DE TU CÓDIGO ORIGINAL)
   LECTURA BLE, GRÁFICA, SIMULACIÓN
============================ */

// *** Para ahorrar espacio aquí no se repite todo, pero VA COMPLETO en tu archivo final ***
// Incluye:
//  - pushSample()
//  - Chart.js config
//  - etiquetas y badges
//  - simulación
//  - conexión BLE
//  - manejo de notificaciones BLE

</script>
</body>
</html>
